<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Analytics Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/admin-panel.css}">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>âš™ï¸ Admin Dashboard</h1>
        <div class="actions">
            <a th:href="@{/dashboard}" class="btn">ğŸ  Home</a>
            <a th:href="@{/items/browse}" class="btn">ğŸ“‹ Browse</a>
            <a th:href="@{/messages}" class="btn">âœ‰ï¸ Messages</a>
            <a th:href="@{/my-items}" class="btn">ğŸ“¦ My Items</a>
            <a th:href="@{/my-alerts}" class="btn">ğŸ”” Alerts</a>
            <a th:href="@{/logout}" class="btn btn-danger">ğŸšª Logout</a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats">
        <div class="card">
            <div class="label">Total Users</div>
            <div class="value" th:text="${totalUsers}">0</div>
        </div>
        <div class="card">
            <div class="label">Total Items</div>
            <div class="value" th:text="${totalItems}">0</div>
        </div>
        <div class="card">
            <div class="label">Lost Items</div>
            <div class="value" th:text="${lostItems}">0</div>
        </div>
        <div class="card">
            <div class="label">Found Items</div>
            <div class="value" th:text="${foundItems}">0</div>
        </div>
        <div class="card">
            <div class="label">Active Items</div>
            <div class="value" th:text="${activeItems}">0</div>
        </div>
        <div class="card">
            <div class="label">Resolved Items</div>
            <div class="value" th:text="${resolvedItems}">0</div>
        </div>
    </div>

    <!-- â­ CSV EXPORT SECTION -->
    <div class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; border-radius: 12px; margin: 20px 0;">
        <h2 style="color: white; margin: 0 0 16px 0; font-size: 1.3rem;">ğŸ“¥ Export Reports</h2>
        <p style="color: rgba(255,255,255,0.9); margin: 0 0 20px 0; font-size: 0.95rem;">
            Download item reports in CSV format for analysis or archiving
        </p>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <a th:href="@{/reports/items.csv}"
               class="btn"
               style="background: white; color: #667eea; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                ğŸ“¥ Export All Items
            </a>
            <a th:href="@{/reports/items.csv(itemType='LOST')}"
               class="btn"
               style="background: #FF6B6B; color: white; font-weight: 600; box-shadow: 0 4px 15px rgba(255,107,107,0.3);">
                ğŸ“¥ Export Lost Items
            </a>
            <a th:href="@{/reports/items.csv(itemType='FOUND')}"
               class="btn"
               style="background: #4ECDC4; color: white; font-weight: 600; box-shadow: 0 4px 15px rgba(78,205,196,0.3);">
                ğŸ“¥ Export Found Items
            </a>
        </div>
        <p style="color: rgba(255,255,255,0.8); margin: 16px 0 0 0; font-size: 0.85rem;">
            ğŸ’¡ CSV files can be opened in Excel, Google Sheets, or converted to PDF
        </p>
    </div>

    <div class="charts-container">
        <!-- Row 1: Lost vs Found + Items by Category -->
        <div class="charts-row">
            <!-- Lost vs Found Pie Chart -->
            <div class="chart-card">
                <h3>ğŸ“Š Lost vs Found Items</h3>
                <canvas id="lostFoundChart"></canvas>
            </div>

            <!-- Items by Category Bar Chart -->
            <div class="chart-card">
                <h3>ğŸ“¦ Items by Category</h3>
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <!-- Row 2: Most Active Members -->
        <div class="charts-row">
            <div class="chart-card full-width">
                <h3>ğŸ‘¥ Most Active Members (Top 5)</h3>
                <canvas id="activeUsersChart"></canvas>
            </div>
        </div>
    </div>

    <!-- All Items Section -->
    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">ğŸ“¦ All Items</h2>
            <a th:href="@{/reports/items.csv}"
               class="btn"
               style="background: #10b981; color: white;">
                ğŸ“¥ Export Table
            </a>
        </div>
        <table class="table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Name</th>
                <th>Category</th>
                <th>Owner</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item : ${items}">
                <td th:text="${item.itemId}">1</td>
                <td>
                    <span th:text="${item.itemType}"
                          th:style="${item.itemType == 'LOST' ? 'color: #FF6B6B; font-weight: 600;' : 'color: #4ECDC4; font-weight: 600;'}">
                        LOST
                    </span>
                </td>
                <td th:text="${item.itemName}">Item Name</td>
                <td th:text="${item.category != null ? item.category.categoryName : 'N/A'}">Category</td>
                <td th:text="${item.user != null ? item.user.fullName : 'Unknown'}">Owner</td>
                <td>
                    <span th:text="${item.status}"
                          th:style="${item.status == 'ACTIVE' ? 'color: #10b981; font-weight: 600;' :
                                    (item.status == 'RESOLVED' ? 'color: #3b82f6; font-weight: 600;' : 'color: #6b7280;')}">
                        ACTIVE
                    </span>
                </td>
                <td>
                    <button class="btn btn-danger delete-item-btn"
                            th:attr="data-item-id=${item.itemId}, data-item-name=${item.itemName}">
                        Delete
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- All Users Section -->
    <div class="section">
        <h2>ğŸ‘¥ All Users</h2>
        <table class="table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Full Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="user : ${users}">
                <td th:text="${user.userId}">1</td>
                <td th:text="${user.username}">username</td>
                <td th:text="${user.fullName}">Full Name</td>
                <td th:text="${user.email}">email@example.com</td>
                <td>
                    <span th:text="${user.role}"
                          th:style="${user.role == 'ADMIN' ? 'color: #7E57C2; font-weight: 600;' : 'color: #6b7280;'}">
                        MEMBER
                    </span>
                </td>
                <td>
                    <button class="btn btn-danger delete-user-btn"
                            th:if="${user.role != 'ADMIN'}"
                            th:attr="data-user-id=${user.userId}, data-username=${user.username}">
                        Delete
                    </button>
                    <span th:if="${user.role == 'ADMIN'}" style="color: #9ca3af; font-size: 0.875rem;">
                        Protected
                    </span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Chart.js Initialization Script -->
<script th:inline="javascript">
    /*<![CDATA[*/

    // Get data from Thymeleaf
    const lostCount = /*[[${lostCount}]]*/ 0;
    const foundCount = /*[[${foundCount}]]*/ 0;

    const topUserNames = /*[[${topUserNames}]]*/ [];
    const topUserCounts = /*[[${topUserCounts}]]*/ [];

    const categoryNames = /*[[${categoryNames}]]*/ [];
    const categoryCounts = /*[[${categoryCounts}]]*/ [];


    // 1. LOST vs FOUND PIE CHART
    const lostFoundCtx = document.getElementById('lostFoundChart').getContext('2d');
    new Chart(lostFoundCtx, {
        type: 'pie',
        data: {
            labels: ['Lost Items', 'Found Items'],
            datasets: [{
                data: [lostCount, foundCount],
                backgroundColor: [
                    '#FF6B6B',  // Red for Lost
                    '#4ECDC4'   // Teal for Found
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: { size: 14 },
                        padding: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = lostCount + foundCount;
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return label + ': ' + value + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });


    // 2. ITEMS BY CATEGORY BAR CHART
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'bar',
        data: {
            labels: categoryNames,
            datasets: [{
                label: 'Number of Items',
                data: categoryCounts,
                backgroundColor: '#7E57C2',
                borderColor: '#5E35B1',
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: { size: 12 }
                    }
                },
                x: {
                    ticks: {
                        font: { size: 12 }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Items: ' + context.parsed.y;
                        }
                    }
                }
            }
        }
    });


    // 3. MOST ACTIVE MEMBERS HORIZONTAL BAR CHART
    const activeUsersCtx = document.getElementById('activeUsersChart').getContext('2d');
    new Chart(activeUsersCtx, {
        type: 'bar',
        data: {
            labels: topUserNames,
            datasets: [{
                label: 'Items Posted',
                data: topUserCounts,
                backgroundColor: [
                    '#FF6B6B',
                    '#4ECDC4',
                    '#45B7D1',
                    '#FFA07A',
                    '#98D8C8'
                ],
                borderWidth: 2,
                borderColor: '#fff',
                borderRadius: 8
            }]
        },
        options: {
            indexAxis: 'y',  // Horizontal bars
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: { size: 12 }
                    }
                },
                y: {
                    ticks: {
                        font: { size: 13 }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Posts: ' + context.parsed.x;
                        }
                    }
                }
            }
        }
    });

    /*]]>*/
</script>

<!-- Admin Panel JavaScript for Delete Functionality -->
<script th:src="@{/js/admin-panel.js}"></script>
</body>
</html>

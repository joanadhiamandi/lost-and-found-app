<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${item.itemName} + ' - Lost & Found'">Item Details</title>
    <link rel="stylesheet" th:href="@{/css/item-detail.css}">
</head>
<body>
<!-- Navigation -->
<nav>
    <div style="font-weight: 700; font-size: 18px;">ğŸ“¦ Lost & Found</div>
    <div>
        <a th:href="@{/dashboard}">ğŸ  Home</a>
        <a th:href="@{/items/browse}">ğŸ” Browse</a>
        <a th:href="@{/messages}">âœ‰ï¸ Messages</a>
        <a th:href="@{/my-items}">ğŸ“‹ My Items</a>
        <a th:if="${loggedInUser.role == 'ADMIN'}" th:href="@{/admin-panel}">âš™ï¸ Admin</a>
        <a th:href="@{/logout}" style="color: #f87171;">ğŸšª Logout</a>
    </div>
</nav>

<div class="container">
    <!-- Success/Error Messages -->
    <div th:if="${param.success != null}" style="background: #d4edda; color: #155724; padding: 16px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #c3e6cb;">
        <strong th:if="${param.success[0] == 'commented'}">âœ… Comment posted successfully!</strong>
        <strong th:if="${param.success[0] == 'deleted'}">âœ… Comment deleted successfully!</strong>
    </div>

    <div th:if="${param.error != null}" style="background: #f8d7da; color: #721c24; padding: 16px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
        <strong th:if="${param.error[0] == 'empty'}">âŒ Comment cannot be empty.</strong>
        <strong th:if="${param.error[0] == 'toolong'}">âŒ Comment is too long (max 500 characters).</strong>
        <strong th:if="${param.error[0] == 'unauthorized'}">âŒ You don't have permission to delete this comment.</strong>
    </div>

    <!-- Item Card -->
    <div class="item-card">
        <!-- Header with badges -->
        <div class="item-meta">
            <span class="badge" th:classappend="${item.itemType == 'LOST'} ? 'badge-lost' : 'badge-found'"
                  th:text="${item.itemType}">LOST</span>
            <span class="badge" th:classappend="${item.status == 'ACTIVE'} ? 'badge-active' : 'badge-resolved'"
                  th:text="${item.status}">ACTIVE</span>
            <span style="margin-left: auto; color: #6c757d; font-size: 0.9rem;">
                ğŸ‘ï¸ <span th:text="${viewCount}">0</span> views Â·
                ğŸ’¬ <span th:text="${commentCount}">0</span> comments
            </span>
        </div>

        <h1 th:text="${item.itemName}">Item Name</h1>

        <!-- Item Info -->
        <div class="item-info">
            <p><strong>ğŸ“‚ Category:</strong> <span th:text="${categoryName ?: 'N/A'}">Category</span></p>
            <p><strong>ğŸ“ Location:</strong> <span th:text="${item.location}">Location</span></p>
            <p><strong>ğŸ“… Date:</strong> <span th:text="${#temporals.format(item.dateLostFound, 'dd MMM yyyy')}">Date</span></p>
            <p><strong>ğŸ‘¤ Posted by:</strong> <span th:text="${postedByUsername}">Username</span></p>
            <p th:if="${item.contactInfo}"><strong>ğŸ“ Contact:</strong> <span th:text="${item.contactInfo}">Contact</span></p>
            <p><strong>ğŸ• Posted:</strong> <span th:text="${#temporals.format(item.createdAt, 'dd MMM yyyy HH:mm')}">Created</span></p>
        </div>

        <!-- Description -->
        <div class="item-description" th:if="${item.description}">
            <h3>ğŸ“ Description</h3>
            <p th:text="${item.description}">Description text...</p>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <!-- If NOT owner -->
            <div th:unless="${isOwner}">
                <button id="messageBtn" class="btn btn-primary" th:attr="data-item-id=${item.itemId}">
                    âœ‰ï¸ Message Owner
                </button>
                <button id="copyLinkBtn" class="btn btn-secondary">ğŸ”— Copy Link</button>
            </div>

            <!-- If owner -->
            <div th:if="${isOwner}">
                <a th:href="@{/items/edit/{id}(id=${item.itemId})}" class="btn btn-primary">âœï¸ Edit</a>

                <form th:if="${item.status == 'ACTIVE'}" th:action="@{/items/{id}/resolve(id=${item.itemId})}" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-success">âœ… Mark as Resolved</button>
                </form>

                <form th:action="@{/items/delete}" method="post" style="display: inline;"
                      onsubmit="return confirm('Are you sure you want to delete this item?');">
                    <input type="hidden" name="itemId" th:value="${item.itemId}">
                    <button type="submit" class="btn btn-danger">ğŸ—‘ï¸ Delete</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ğŸ’¬ COMMENTS SECTION-->
    <div class="comments-section">
        <h2 style="color: #333; font-size: 1.75rem; margin-bottom: 24px; border-bottom: 3px solid #667eea; padding-bottom: 10px;">
            ğŸ’¬ Discussion (<span th:text="${commentCount}">0</span>)
        </h2>

        <!-- Add Comment Form -->
        <div class="comment-form">
            <h3 style="color: #333; font-size: 1.25rem; margin-bottom: 16px;">Leave a Comment</h3>
            <form th:action="@{/items/{id}/comment(id=${item.itemId})}" method="post">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                        ğŸ‘¤
                    </div>
                    <strong th:text="${loggedInUser.fullName}" style="color: #333;">Your Name</strong>
                </div>

                <textarea name="commentText"
                          placeholder="Share your thoughts, ask questions, or provide helpful information about this item..."
                          maxlength="500"
                          required
                          rows="4"
                          style="width: 100%; padding: 14px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 0.95rem; font-family: inherit; resize: vertical; min-height: 100px;"></textarea>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <span class="char-counter" style="font-size: 0.85rem; color: #6c757d;">Max 500 characters</span>
                    <button type="submit" class="btn btn-primary">Post Comment</button>
                </div>
            </form>
        </div>

        <!-- Comments List -->
        <div class="comments-list">
            <!-- No comments message -->
            <div th:if="${comments.isEmpty()}" style="text-align: center; padding: 40px; color: #999; background: #f8f9fa; border-radius: 12px;">
                <p style="font-size: 1.1rem;">ğŸ’­ No comments yet. Be the first to comment!</p>
            </div>

            <!-- Comments -->
            <div th:each="comment : ${comments}" class="comment">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                            ğŸ‘¤
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #333; font-size: 15px;" th:text="${comment.user.fullName}">User Name</div>
                            <div style="font-size: 12px; color: #999; margin-top: 2px;" th:text="${#temporals.format(comment.createdAt, 'dd MMM yyyy, HH:mm')}">Date</div>
                        </div>
                    </div>

                    <!-- Delete button (author/owner/admin only) -->
                    <form th:if="${comment.user.userId == loggedInUser.userId ||
                                   item.user.userId == loggedInUser.userId ||
                                   loggedInUser.role == 'ADMIN'}"
                          th:action="@{/comments/{id}/delete(id=${comment.commentId})}"
                          method="post"
                          style="display: inline;"
                          onsubmit="return confirm('Delete this comment?');">
                        <button type="submit"
                                style="background: transparent; border: none; cursor: pointer; font-size: 18px; padding: 5px 10px; border-radius: 6px; transition: all 0.3s;"
                                onmouseover="this.style.background='#fee2e2'"
                                onmouseout="this.style.background='transparent'">
                            ğŸ—‘ï¸
                        </button>
                    </form>
                </div>

                <div style="padding-left: 52px;">
                    <p style="color: #555; line-height: 1.6; word-wrap: break-word;" th:text="${comment.commentText}">Comment text goes here...</p>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Message Modal (Keep your existing modal) -->
<div id="messageModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>âœ‰ï¸ Send Message to Owner</h2>
            <button class="close-btn" onclick="closeMessageModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <textarea id="messageInput" placeholder="Type your message here..." maxlength="1000"></textarea>
            <div class="char-count" id="charCount">0/1000</div>
            <div class="error-message" id="modalError"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeMessageModal()">Cancel</button>
            <button class="btn btn-primary" onclick="sendMessageFromModal()">Send Message</button>
        </div>
    </div>
</div>

<script th:src="@{/js/item-detail.js}"></script>
<script>
    // Character counter for comment form
    document.addEventListener('DOMContentLoaded', function() {
        const textarea = document.querySelector('textarea[name="commentText"]');
        const charCounter = document.querySelector('.char-counter');

        if (textarea && charCounter) {
            textarea.addEventListener('input', function() {
                const remaining = 500 - this.value.length;
                charCounter.textContent = `${remaining} characters remaining`;

                if (remaining < 50) {
                    charCounter.style.color = '#dc3545';
                } else {
                    charCounter.style.color = '#6c757d';
                }
            });
        }
    });
</script>
</body>
</html>
